---
- name: Set host_groups
  set_fact:
    host_groups: |
      {%- set hostGroups = {} -%}
      {%- for v in vcd_vms[group] -%}
        {%- for g in v.host_groups|default([]) -%}
          {%- if hostGroups[g] is not defined -%}
            {%- set _ = hostGroups.update({g:[]}) -%}
          {%- endif -%}
          {%- set _ = hostGroups[g].append(v.hostname) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ hostGroups }}

- name: "Debug host_groups {{ group }}"
  debug:
    msg: "{{ host_groups }}"
- name: Create inventory group_vars dir
  file:
    path: "{{ inventories_dir }}/vcd-{{ group }}/group_vars/all"
    state: directory
    mode: "0755"
    recurse: true

- name: Copy init variables
  file:
    src: "../../../../variables/init.yml"
    dest: "{{ inventories_dir }}/vcd-{{ group }}/group_vars/all/init.yml"
    state: link

- name: Create inventory group_vars default all.yml
  file:
    path: "{{ inventories_dir }}/vcd-{{ group }}/group_vars/all/all.yml"
    state: touch
    mode: "0655"

- name: Create inventory host_vars dir
  file:
    path: "{{ inventories_dir }}/vcd-{{ group }}/host_vars/{{ item.hostname }}"
    state: directory
    mode: "0755"
    recurse: true
  loop: "{{ vcd_vms[group] }}"

- name: "Create inventory hosts"
  template:
    src: "vcd-inventory.ini.j2"
    dest: "{{ inventories_dir }}/vcd-{{ group }}/hosts"
    mode: "0655"

- name: "Create netplan-config-default"
  template:
    src: "netplan-config-default.yml.j2"
    dest: "{{ inventories_dir }}/vcd-{{ group }}/host_vars/{{ item.hostname }}/netplan-config-default.yml"
    mode: "0655"
  loop: "{{ vcd_vms[group] }}"
